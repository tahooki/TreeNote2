<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<title>TreeNote</title>
<link rel="stylesheet"href="resources/css/blue.css">
<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="resources/css/alertModal.css">

<link href="//fonts.googleapis.com/css?family=Roboto:300" rel="stylesheet" type="text/css"/>
<link href="resources/css/main.css" rel="stylesheet" type="text/css"/>
<script src="resources/js/jquery.min.js"></script>
<style type="text/css">

</style>

<script type="text/javascript">
	$.ajax({
		url:'/user/index',
		contentType:"application/json",
		dataType:"json",
		success:function(data){
			if(data.boolean==true){
				self.location="main.html"
			}
		},
		async:false
	
	})
</script>
</head>


<body cz-shortcut-listen="true">
<div id="wrapper" style="width: 620px; height:700px; background-image: url('/resources/img/loginpage.png'); margin:0 auto; margin-top:20px; padding-top:130px; background-repeat: no-repeat;">
  <div id="container">
	<section class="tabs">
		<input id="tab-1" type="radio" name="radio-set" class="tab-selector-2" checked="checked">
		<span for="tab-1" class="tab-label-1">Login</span>


		<input id="tab-2" type="radio" name="radio-set" class="tab-selector-1" >
		<span for="tab-2" class="tab-label-2">Signup</span>
	
		<div class="clear-shadow"></div>
		
		<div id="content">
			<div class="content-2">
				<form id="loginaction" action="/user/login" method="post"  >
				  <p>
					<input class="field" name="email" required="required" type="email" placeholder="Name or Email">
				  </p>
				  <p>
					<input class="field" name="password" required="required" type="password" placeholder="Password">
				  </p>
				  
				  <p>
				  	<div id="loginbutton" style="clear:both; opacity: 1;position: relative; float: left; background-color: #449D44; border-radius: 3px; width: 99%;
				  	text-align: center; font-size:x-large; height: 24px;cursor:pointer; ">SIGN IN</div>
				  </p>
				  <p>
				  	<div id="fLoginbutton" style="clear:both; opacity: 1;position: relative; float: left; background-color: #3A5795; border-radius: 3px; width: 100%;
				  	text-align: center; font-size:x-large; height: 24px;color:white;padding-bottom: 4px;padding-top: 4px; cursor:pointer;">facebook</div>
				  </p>
				</form>
			</div>
			
			
<!--///////////////////////////////////////////////////////////////////////////////////////////////////////////////////  -->				 	
			
	
			
			
			<div class="content-1">
				<form id="signUpForm" enctype="multipart/form-data" >
				 	
				 	
<!--///////////////////////////////////////////////////////////////////////////////////////////////////////////////////  -->				 	
			   <!-- <div class="content" style=" opacity: 1; cursor:pointer; text-align: center; min-height:200px; margin-top:15px;">
					<img id='profilImage'  src="resources/css/uploader/userpic.gif" style="width:200px;height:200px;">
					<input type="file" name="file" hidden/>
				
				</div> -->

<!--///////////////////////////////////////////////////////////////////////////////////////////////////////////////////  -->				 	
				  
				 	
				 	
				 	
<!--///////////////////////////////////////////////////////////////////////////////////////////////////////////////////  -->				 	
				 	
				  <p>
					<input class="field" name="name" required="required" type="text" placeholder="Your Name">
				  </p> 
				  <p>
					<input class="field" name="email" required="required" type="email" placeholder="Email">
				  </p>
				  <p>
					<input id="passwordprogress" class="field" name="password" required="required" type="password" placeholder="Password">
					<span class="progress" style="height: 4px; width:100%; position:relative;background-color:white;padding:0px;border-radius:2px;margin-top:2px">
						<span id="passwordProgressBar" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 0%;height: 4px ;opacity:1;margin:0px;padding:0px;"></span>
					</span>
				  </p>
				  	
				  <p>
					<input class="field"  name="passwordCheck" required="required" type="password" placeholder="Confirm Password">
				  </p>
				  <p class="signin button">
					<input type="checkbox" required="required"> I agree with terms and conditions 
				  </p>
				  <p>
				  	<div id="signUpButton" style="clear:both; opacity: 1;position: relative; float: left; background-color: #449D44; border-radius: 3px; width: 100%;
				  	text-align: center; font-size:x-large; height: 24px;color:white;padding-bottom: 4px;padding-top: 4px; cursor:pointer;">SIGN UP</div>
				  </p>
				  <p>
				  	<div id="facebookSignup" style="clear:both; opacity: 1;position: relative; float: left; background-color: #3A5795; border-radius: 3px; width: 100%;
			  		text-align: center; font-size:x-large; height: 24px;color:white;padding-bottom: 4px;padding-top: 4px; cursor:pointer;">facebook</div>
			  	  </p>
				</form>
			</div>
			
			
			
		</div>
	</section>
  </div>
</div>

<!-- <script type="text/javascript" src="../resources/js/facebookLogin.js"></script> -->




<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Modal Header</h4>
      </div>
      <div class="modal-body">
        <p>Some text in the modal.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>


<div id="myModal2" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">alert</h4>
      </div>
      <div class="modal-body">
        <p>아이디와 비밀번호가 일치 하지 않음</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>






<script type="text/javascript" src="resources/js/jqueryFileUpload/vendor/jquery.ui.widget.js"></script>
<script type="text/javascript" src="resources/js/jqueryFileUpload/jquery.fileupload.js"></script>
<script type="text/javascript" src="resources/js/jqueryFileUpload/form.js"></script>
<script type="text/javascript">
	//Ajax form 전송용 함수
	function getFormData($form){
	    var unindexed_array = $form.serializeArray();
	    var indexed_array = {};

	    $.map(unindexed_array, function(n, i){
	        indexed_array[n["name"]] = n["value"];
	    });

	    return indexed_array;
	}
	
	$('#loginaction input[name=password]').on('keypress',function(e){
		if(e.keyCode==13){
			$('#loginbutton').click();
		}
	})
	
//로그인 버튼
$("#loginbutton").click(function() {
	var str = $('#loginaction')
	var user = getFormData(str)
	

	$.ajax({
		  type: 'POST',
		  url: '/user/login',
		  data: JSON.stringify(user),
		  contentType : 'application/json; charset=utf-8',
		  success : function(data){
			  console.log(data)
			  console.log(data.success);
				if(data.boolean){
						 self.location="/main.html" 
						 if (window.sessionStorage) {
							 sessionStorage.setItem('userNo', data.user.userNo);
               sessionStorage.setItem('editTreeNo', data.user.editTreeNo);
               //var position = sessionStorage.getItem('저장된 이름');
            			 }
				}else{
					$("#signUpForm p input[name=name]").attr('data-toggle','modal').attr('data-target','#myModal2');
					$("#signUpForm p input[name=name]").click()
					$("#signUpForm p input[name=name]").removeAttr('data-toggle').removeAttr('data-target')
					$('.field').val('');
				}
		  },
		  dataType: "json"
		});
	
	
})
/*전역*/
var checkEmail =false;
var checkPassword = false;
var checkName = false;

//name check
$('#signUpForm p input[name=name]').on('focusout',function(){
	if($('#signUpForm p input[name=name]').val()!=""){
		checkName = true;
	}else{
		checkName = false;
	}
})

$('#signUpForm p input[name=passwordCheck]').on('focusout',function(){
	if($('#signUpForm p input[name=password]').val() !=$('#signUpForm p input[name=passwordCheck]').val()){
		$('#signUpForm p input[name=passwordCheck]').css('border-color','red')
		checkPassword = false;
	}else{
		checkPassword = true;
	}
})

$('#signUpForm p input[name=passwordCheck]').on('focusin',function(){
	$('#signUpForm p input[name=passwordCheck]').css('border-color','rgb(85, 85, 85)')
})



//회원가입 버튼 
$('#signUpButton').on('click',function(){
	var formdata = getFormData($('#signUpForm'))
	if(checkEmail&&checkPassword&&checkName){
		$.ajax({
			method:'post',
			url:'/user/addUser',
			data:formdata,
			success : function(data) {		
				//정태가 추가한 부분				
				alertEmail()
				self.location="index.html";
				sendEmail();
			},

			error : function(error) {

				alert("요청 처리 중 오류가 발생하였습니다.");

			}
		
		});
// 		$.ajax({
// 			url:'/user/addUser',
// 			method:'POST',
//     	    processData: false,
//     	    contentType: false,
// 			data: formData,
// 			success:function(data){
// 				if(data){
// 					self.location='/main.html'
// 				}
// 			}
// 		})
		
		

	}else{
		$("#signUpForm p input[name=name]").attr('data-toggle','modal').attr('data-target','#myModal');
		$("#signUpForm p input[name=name]").click()
	}	

}).on()




//중복 이메일 체크 
 $('#signUpForm p input[name=email]').on('focusout',function(){
	var temp = $('#signUpForm p input[name=email]').val()
	var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
	$('#appendmessage').remove();
	if (re.test(temp) ){  
		
			$.ajax({
				type:'post',
				url:'/user/checkDuplication',
				contentType : 'application/json',
				data:temp,
				dataType : 'json',
				success : function(data){
					
					if(data.boolean){
						$('#signUpForm p input[name=email]').after('<p id="appendmessage" class="signin button" style="color:red; ">이미 가입된 이메일 입니다.</p>')
						checkEmail = false;
					}else{
						$('#signUpForm p input[name=email]').after('<p id="appendmessage" class="signin button" >사용 가능한 이메일 입니다.</p>')
						checkEmail=true;
					}
				}
			})
  } else if(temp==""){
	  
  }	else{
	  
	  $('#signUpForm p input[name=email]').after('<p id="appendmessage" class="signin button" style="color:red;" >올바른 양식이 아닙니다..</p>')
  } 
	


})
//정태가 추가한 부분 시작
function alertEmail(){
	var name = $('#signUpForm p input[name=name]').val();
	var reseiver =  $('#signUpForm p input[name=email]').val();
	var tempArray1 = reseiver.split("@");
	var tempArray2 = tempArray1[1].split(".");
	var homepage = tempArray2[0].substring(0,1).toUpperCase() + tempArray2[0].substring(1,tempArray2[0].length).toLowerCase();
	
	alert(name+"님 "+homepage+"로 가서 E-Mail 인증을 해주세요.");
}

function sendEmail(){
	var reseiver =  $('#signUpForm p input[name=email]').val();
	var name = $('#signUpForm p input[name=name]').val();
	var activityNo = Math.floor(Math.random() * 999999) + 1;
	
	console.log("reseiver"+reseiver);
	console.log("name"+name);
	console.log("activityNo"+activityNo);
	
	var content ="<div class='bb' >"+
						"<p><font style='font-size: 23px'>가입을 위해 Tree 계정 인증이 필요합니다</font></p>"+
						"<hr>"+
						"<p><font style='font-size: 17px'>"+name+"님, 안녕하세요</font></p>"+		
						"<p><font style='font-size: 17px'>Tree에 가입해주셔서 감사합니다</font></p>"+
						"<p><font style='font-size: 17px'>Tree 가입을 완료하려면 계정을 확인하세요</font></p>"+
						"<p><font style='font-size: 20px'>"+
						"<a href='http://127.0.0.1:8080/user/sendEmailCheck?&reseiver="+reseiver+"&activityNo="+activityNo+"'>계정확인</a></font></p>"+
					"</div>"+ 
					"</div>";										
		
	$.ajax( 
			{
				url : "/user/sendEmali/" ,
				method : "POST" ,
				dataType : "json" ,
				data: JSON.stringify({
					reseiver : reseiver,											
					content : content,
					activityNo : activityNo
				}),
				headers : {
					"Accept" : "application/json",
					"Content-Type" : "application/json"
				},							
				success : function(JSONData , status) {										
					
				}				
	});	
}
// 정태가 추가한 부분 끝

</script>
<script type="text/javascript" src="resources/js/common-passwords.js"></script>
<script type="text/javascript">
	
	//패스워드 강도 체크
	$(function(){
		
		function isCommon(pass){
			return ~window.commonPasswords.indexOf(pass);
		}

		function bruteMagnitude(pass) {
	        var sets = [
	            { regex: /\d/g, size: 10 },
	            { regex: /[a-z]/g, size: 26 },
	            { regex: /[A-Z]/g, size: 26 },
	            { regex: /[!-/:-?\[-`{-}]/g, size: 24 },
	        ];
	        var passlen = pass.length,
	            szSet = 0;

	        sets.forEach(function(set) {
	            if (set.regex.test(pass)) {
	                szSet += set.size;
	                pass = pass.replace(set.regex, '');
	            }
	        });
	        // other (unicode) characters
	        if (pass.length) szSet += 20;
	        return passlen * Math.log(szSet) / Math.log(10);
    	}

		var strengths = ['transparent','red', '#fa00ff', '#6a00ff', '#0800ff', '#00a1ff', '#00ffa5','#00ff48']

		function strength(pass) {
	        if (isCommon(pass) || !pass.length) return 0;
	        var str = bruteMagnitude(pass);
	        return str < 1 ? 0
	        	 :str < 7  ? 1 // very poor
	             : str < 9  ? 2 // poor      - 10 million - 1 billion
	             : str < 11 ? 3 // passing   - 1 billion - 100 billion
	             : str < 13 ? 4 // fair      - 100 billion - 10 trillion
	             : str < 15 ? 5 // good      - 10 trillion - 1 quadrillion
	             : str < 17 ? 6 // very good - 1-100 quadrillion
	             : 7;           // excellent - over 100 quadrillion
  		 }

		$('#passwordprogress').on('keyup keypress', function(){
			var pstrength = strength($(this).val());
			$('#passwordProgressBar').css('background-color',strengths[pstrength]).attr('aria-valuenow',100*(pstrength)/7).css('width',100*(pstrength)/7+"%")
			
		})

	})
</script>

<script type="text/javascript" src="resources/js/facebookLogin.js"></script>
<script type="text/javascript">
 $('#facebookSignup').on('click',function(){
	 signup();	
 });
 $('#fLoginbutton').on('click',function(){
	 fLogin()
 });
 
//  fileUpload
 function readURL(input) {
     if (input.files && input.files[0]) {
         var reader = new FileReader();            
         reader.onload = function (e) {
             $('#profilImage').attr('src', e.target.result);
         }
         
         reader.readAsDataURL(input.files[0]);
     }
 }
 
 $("input[type=file]").change(function(){
     readURL(this);
 });
 
 $('#profilImage').on('click',function(){
	 $("input[type=file]").click()
 })
 
 
</script>


</body>
</html>